name: Nightly E2E Tests (Complete Suite)

on:
  schedule:
    # Run every day at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch: # Allow manual trigger

jobs:
  nightly-tests:
    name: Nightly Full Test Suite
    timeout-minutes: 60
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Create .env file
        run: |
          echo "SAUCE_USERNAME=standard_user" >> .env
          echo "SAUCE_PASSWORD=secret_sauce" >> .env

      - name: Run complete test suite
        run: npm test
        continue-on-error: true

      - name: Generate test summary
        if: always()
        run: |
          echo "# ðŸŒ™ Nightly Test Report - $(date '+%Y-%m-%d')" > nightly-summary.md
          echo "" >> nightly-summary.md
          echo "## Test Execution" >> nightly-summary.md
          echo "- **Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> nightly-summary.md
          echo "- **Branch:** ${{ github.ref_name }}" >> nightly-summary.md
          echo "- **Commit:** ${{ github.sha }}" >> nightly-summary.md
          echo "" >> nightly-summary.md
          echo "## User Types Tested" >> nightly-summary.md
          echo "1. âœ… Standard User" >> nightly-summary.md
          echo "2. âŒ Locked Out User" >> nightly-summary.md
          echo "3. âš ï¸ Problem User" >> nightly-summary.md
          echo "4. â±ï¸ Performance Glitch User" >> nightly-summary.md
          echo "" >> nightly-summary.md
          echo "## Artifacts" >> nightly-summary.md
          echo "- HTML Report" >> nightly-summary.md
          echo "- JSON Results" >> nightly-summary.md
          echo "- JUnit XML" >> nightly-summary.md
          echo "- Screenshots (failures)" >> nightly-summary.md
          echo "- Videos (failures)" >> nightly-summary.md
          echo "- Traces (failures)" >> nightly-summary.md

      - name: Upload nightly summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-summary-$(date '+%Y-%m-%d')
          path: nightly-summary.md
          retention-days: 90

      - name: Upload complete HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-playwright-report-$(date '+%Y-%m-%d')
          path: playwright-report/
          retention-days: 90

      - name: Upload all test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-test-results-$(date '+%Y-%m-%d')
          path: test-results/
          retention-days: 90

      - name: Create GitHub Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Nightly Tests Failed - ' + new Date().toISOString().split('T')[0],
              body: `## Nightly Test Failure\n\n**Date:** ${new Date().toUTCString()}\n**Branch:** ${context.ref}\n**Commit:** ${context.sha}\n\n**Action:** [View Run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n### Next Steps\n1. Download artifacts from the failed run\n2. Review HTML report for failures\n3. Check if failures are expected (problem_user)\n4. Investigate unexpected failures\n\n### Expected Behavior\n- Standard user: Should pass\n- Locked out user: Login should fail (expected)\n- Problem user: Some UI tests should fail (expected)\n- Performance user: Should pass but slow\n\nSee [EXPECTED_BEHAVIORS.md](./EXPECTED_BEHAVIORS.md) for details.`,
              labels: ['test-failure', 'nightly', 'automated']
            })
